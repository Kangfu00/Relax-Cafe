<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Relax Cafe - Orders</title>
<style>
    /* --- Relax Cafe Theme Styles --- */
    body { font-family: "Prompt", sans-serif; background-color: #d8bc9b; margin: 0; padding: 0; }
    
    /* Navbar */
    .navbar { display: flex; justify-content: center; gap: 70px; padding: 20px 0; font-size: 22px; font-weight: bold; }
    .navbar a { color: #5d5d5d; text-decoration: none; transition: color 0.2s; }
    .navbar .active { color: #7e50c8; border-bottom: 3px solid #7e50c8; padding-bottom: 5px; }
    
    /* Container */
    .content-container { background: #fdfae9; width: 90%; margin: 20px auto 0; border-radius: 6px; padding: 40px; box-sizing: border-box; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); min-height: 600px; }
    
    h2 { text-align: center; margin-top: 0; font-size: 28px; color: #5d5d5d; }
    
    /* Filter Bar */
    .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; justify-content: flex-end; }
    .search-box { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 250px; background: #f1f1e9; }
    .filter-select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; background: #f1f1e9; }

    /* Form Styles */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { margin-bottom: 6px; font-weight: 600; color: #5d5d5d; }
    input, select, textarea { padding: 10px; border-radius: 6px; border: none; background: #f1f1e9; font-size: 16px; }
    
    .submit-btn { background-color: #69c84c; color: white; padding: 12px 25px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; margin-top: 25px; display: block; margin-left: auto; }
    .submit-btn:hover { background-color: #58a83e; }

    /* Table / List Styles */
    .list-header { display: grid; grid-template-columns: 80px 120px 1fr 100px 100px 100px 60px; gap: 10px; padding: 12px 10px; text-align: center; font-weight: bold; background-color: #f1f1e9; margin-top: 10px; border-radius: 6px; border-bottom: 2px solid #ccc; }
    
    .list-row { display: grid; grid-template-columns: 80px 120px 1fr 100px 100px 100px 60px; gap: 10px; padding: 12px 10px; text-align: center; background-color: #f1f1e9; margin-top: 10px; border-radius: 6px; align-items: center; font-size: 15px; }
    
    /* Status Badges */
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; min-width: 70px; }
    .st-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .st-preparing { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
    .st-completed { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
    .st-cancelled { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

    .delete-btn { cursor: pointer; color: #ff0000; font-size: 18px; }
    .price-text { color: #2563eb; font-weight: bold; }

    /* Bottom Menu */
    .bottom-menu { display: flex; justify-content: center; gap: 40px; margin: 40px 0; }
    .menu-btn { background-color: white; border: none; padding: 18px 40px; border-radius: 45px; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0px 4px 12px rgba(0,0,0,0.15); transition: 0.2s; border: 2px solid transparent; }
    .menu-btn.active { background-color: #f0e6ff; border: 2px solid #7e50c8; color: #7e50c8; box-shadow: 0px 4px 15px rgba(126, 80, 200, 0.4); }
    
    .page-content { display: none; }
    .page-content.active { display: block; }
</style>
</head>
<body>

    <div class="navbar">
        <a href="index.html">Relax Cafe</a>
        <a href="menu.html">Menu</a>
        <a class="active">Orders</a>
        <a href="users.html">Users</a>
        <a href="Discount .html">Discount</a>
    </div>
    
    <div class="content-container">

        <!-- 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
        <div id="order-list-page" class="page-content active">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
            
            <!-- Search & Filter -->
            <div class="filter-bar">
                <input type="text" id="searchInput" class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ID..." onkeyup="filterOrders()">
                <select id="statusFilter" class="filter-select" onchange="filterOrders()">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                    <option value="preparing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
                    <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                </select>
            </div>

            <div class="list-header">
                <span>ID</span>
                <span>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</span>
                <span style="text-align:left;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î/‡πÇ‡∏õ‡∏£</span>
                <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                <span>‡∏•‡∏ö</span>
            </div>
            <div id="order-list-rows">
                <!-- Data renders here -->
            </div>
        </div>

        <!-- 2. ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
        <div id="add-order-page" class="page-content">
            <h2>‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (Manual)</h2>
            <form id="add-order-form">
                <div class="form-grid">
                    
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer) *</label>
                        <select id="user_select" name="user_id" required>
                            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á *</label>
                        <input type="datetime-local" id="order_date" name="order_date" required>
                    </div>

                    <div class="form-group">
                        <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Total Amount) *</label>
                        <input type="number" name="total_amount" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
                        <select name="order_status">
                            <option value="pending">Pending (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</option>
                            <option value="preparing">Preparing (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥)</option>
                            <option value="completed">Completed (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</option>
                            <option value="cancelled">Cancelled (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Discount ID)</label>
                        <input type="number" name="discount_id" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (Promotion ID)</label>
                        <input type="number" name="promotion_id" placeholder="Optional">
                    </div>

                    <div class="form-group full-width">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
                        <textarea name="note" style="height:60px;"></textarea>
                    </div>
                </div>
                <button type="submit" class="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            </form>
        </div>

    </div>

    <div class="bottom-menu">
        <button class="menu-btn active" id="btn-list" onclick="showPage('order-list-page', this)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        <button class="menu-btn" id="btn-add" onclick="showPage('add-order-page', this)">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    </div>

<script>
    let allOrders = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ù‡∏±‡πà‡∏á Client

    // --- ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ---
    function showPage(pageId, btn) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(btn) btn.classList.add('active');

        if(pageId === 'order-list-page') loadOrders();
    }

    // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users ‡πÉ‡∏™‡πà Dropdown ---
    function loadUsers() {
        fetch('api_orders.php?action=get_users')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('user_select');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                data.forEach(u => {
                    const name = u.Full_Name ? u.Full_Name : u.Username;
                    select.innerHTML += `<option value="${u.User_id}">[${u.User_id}] ${name}</option>`;
                });
            });
    }

    // --- ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ---
    function loadOrders() {
        const listArea = document.getElementById('order-list-rows');
        listArea.innerHTML = '<p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

        fetch('api_orders.php')
            .then(res => res.json())
            .then(data => {
                allOrders = data;
                renderTable(data);
            })
            .catch(err => console.error(err));
    }

    // --- ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    function renderTable(data) {
        const listArea = document.getElementById('order-list-rows');
        listArea.innerHTML = '';

        if(data.length === 0) {
            listArea.innerHTML = '<p style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            return;
        }

        data.forEach(o => {
            // Format Date
            const dateStr = new Date(o.Order_date).toLocaleDateString('th-TH', {
                day:'2-digit', month:'short', year:'2-digit', hour:'2-digit', minute:'2-digit'
            });

            // Status Badge
            let badgeClass = 'st-pending';
            if(o.Order_status === 'preparing') badgeClass = 'st-preparing';
            else if(o.Order_status === 'completed') badgeClass = 'st-completed';
            else if(o.Order_status === 'cancelled') badgeClass = 'st-cancelled';

            // Extras Info
            let extras = [];
            if(o.Discount_id) extras.push(`Disc:${o.Discount_id}`);
            if(o.Promotion_id) extras.push(`Promo:${o.Promotion_id}`);
            const extraStr = extras.length > 0 ? extras.join(', ') : '-';

            const row = document.createElement('div');
            row.className = 'list-row';
            row.innerHTML = `
                <span>#${o.Order_id}</span>
                <span style="font-size:13px;">${dateStr}</span>
                <span style="text-align:left; font-weight:500;">${o.Full_Name || o.Username || 'User:'+o.User_id}</span>
                <span class="price-text">${parseFloat(o.Total_amount).toLocaleString()} ‡∏ø</span>
                <span style="font-size:12px; color:#666;">${extraStr}</span>
                <span><span class="status-badge ${badgeClass}">${o.Order_status}</span></span>
                <span class="delete-btn" onclick="deleteOrder(${o.Order_id})">‚ùå</span>
            `;
            listArea.appendChild(row);
        });
    }

    // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á (Client Side) ---
    function filterOrders() {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const st = document.getElementById('statusFilter').value;

        const filtered = allOrders.filter(o => {
            const nameMatch = (o.Full_Name || '').toLowerCase().includes(txt) || 
                              (o.Username || '').toLowerCase().includes(txt) ||
                              o.Order_id.toString().includes(txt);
            const statusMatch = st === '' || o.Order_status === st;
            return nameMatch && statusMatch;
        });
        renderTable(filtered);
    }

    // --- ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ---
    function deleteOrder(id) {
        if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Order #' + id + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            fetch(`api_orders.php?action=delete&id=${id}`)
                .then(res => res.json())
                .then(res => {
                    if(res.status === 'success') loadOrders();
                    else alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                });
        }
    }

    // --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ---
    document.getElementById('add-order-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch('api_orders.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if(res.status === 'success') {
                alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                this.reset();
                initDate(); // Reset ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                showPage('order-list-page', document.getElementById('btn-list'));
            } else {
                alert('Error: ' + res.message);
            }
        });
    });

    // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
    function initDate() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('order_date').value = now.toISOString().slice(0, 16);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
        loadUsers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ Dropdown
        initDate();
    });

</script>

</body>
</html>